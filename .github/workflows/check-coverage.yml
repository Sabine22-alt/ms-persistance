name: Check Coverage

on:
  workflow_call:

jobs:
  check-coverage:
    name: Check Code Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven

      - name: Run tests and generate JaCoCo report (XML + HTML)
        run: |
          echo "üìä Running tests and generating JaCoCo report..."
          mvn -B -V -DskipTests=false -Djacoco.skip=false clean test jacoco:report

      - name: Extract and display JaCoCo instruction coverage percentage
        run: |
          set -euo pipefail
          THRESHOLD=60.0
          XML_FILE=target/site/jacoco/jacoco.xml
          MISSED=""
          COVERED=""

          if [ -f "$XML_FILE" ]; then
            echo "‚úÖ Found $XML_FILE, extracting INSTRUCTION counter..."
            # Preferred: use xmllint if available
            if command -v xmllint >/dev/null 2>&1; then
              MISSED=$(xmllint --xpath 'string(//counter[@type="INSTRUCTION"]/@missed)' "$XML_FILE" 2>/dev/null || true)
              COVERED=$(xmllint --xpath 'string(//counter[@type="INSTRUCTION"]/@covered)' "$XML_FILE" 2>/dev/null || true)
            else
              # Fallback: take first matching counter tag and parse attributes safely
              LINE=$(grep -o '<counter[^>]*type="INSTRUCTION"[^>]*/>' "$XML_FILE" | head -n1 || true)
              if [ -n "$LINE" ]; then
                MISSED=$(echo "$LINE" | sed -n 's/.*missed="\([0-9]\+\)".*/\1/p' || true)
                COVERED=$(echo "$LINE" | sed -n 's/.*covered="\([0-9]\+\)".*/\1/p' || true)
              fi
            fi
          else
            echo "‚ö†Ô∏è $XML_FILE not found."
          fi

          # Validate numeric values
          MISSED=${MISSED:-0}
          COVERED=${COVERED:-0}
          if ! [[ "$MISSED" =~ ^[0-9]+$ ]] || ! [[ "$COVERED" =~ ^[0-9]+$ ]]; then
            echo "‚ùå Could not determine numeric missed/covered values (missed='${MISSED}' covered='${COVERED}')"
            exit 1
          fi

          TOTAL=$((MISSED + COVERED))
          if [ "$TOTAL" -eq 0 ]; then
            PERCENT="0.00"
          else
            PERCENT=$(awk -v c="$COVERED" -v t="$TOTAL" 'BEGIN{printf "%.2f", (c/t)*100}')
          fi

          echo "üìà JaCoCo instruction coverage: ${PERCENT}% (covered ${COVERED} / total ${TOTAL})"

          # Compare with threshold (float compare using awk)
          BELOW=$(awk -v p="$PERCENT" -v t="$THRESHOLD" 'BEGIN{print (p+0 < t) ? 1 : 0}')
          if [ "$BELOW" -eq 1 ]; then
            echo "‚ùå Coverage ${PERCENT}% is below threshold ${THRESHOLD}%"
            exit 1
          else
            echo "‚úÖ Coverage ${PERCENT}% meets threshold ${THRESHOLD}%"
          fi

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: target/site/jacoco/
          retention-days: 7

      - name: Display coverage report location
        run: |
          if [ -f target/site/jacoco/index.html ]; then
            echo "‚úÖ Coverage report generated: target/site/jacoco/index.html"
          else
            echo "‚ö†Ô∏è No coverage HTML generated"
          fi
